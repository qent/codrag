<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <title>RAG Search</title>
    <style>
        body { font-family: sans-serif; margin: 2rem auto; max-width: 800px; }
        textarea { width: 100%; height: 150px; padding: 1rem; font-size: 1rem; }
        button { margin-top: 1rem; padding: 0.5rem 1rem; font-size: 1rem; cursor: pointer; }
        .result { margin-top: 1rem; }
        .result pre, .result code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
        .result pre { background: #f5f5f5; padding: 1rem; white-space: pre-wrap; border-radius: 4px; overflow-x: auto; }
        .result h1, .result h2, .result h3 { margin-top: 1.2em; }
        .result a { color: #0366d6; text-decoration: none; }
        .result a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <textarea id="query" placeholder="Введите запрос..."></textarea>
    <div>
        <button id="submit">Отправить</button>
        <button id="cancel" disabled>Отменить</button>
        <span id="status" style="margin-left: 1rem; color: #555;"></span>
    </div>
    <div id="result" class="result"></div>
    <script>
    let pollTimer = null;

    function setInProgress(inProgress, elapsedMs = 0) {
        const submit = document.getElementById('submit');
        const cancel = document.getElementById('cancel');
        const status = document.getElementById('status');
        submit.disabled = inProgress;
        cancel.disabled = !inProgress;
        if (inProgress) {
            const secs = Math.floor(elapsedMs / 1000);
            const mm = String(Math.floor(secs / 60)).padStart(2, '0');
            const ss = String(secs % 60).padStart(2, '0');
            status.textContent = `Запрос выполняется… ${mm}:${ss}`;
        } else {
            status.textContent = '';
        }
    }

    async function pollStatus() {
        try {
            const r = await fetch('/search/status');
            const s = await r.json();
            if (s.in_progress) {
                setInProgress(true, s.elapsed_ms || 0);
                // keep polling
            } else {
                setInProgress(false);
                clearInterval(pollTimer); pollTimer = null;
                // stream the result once done
                const out = document.getElementById('result');
                const res = await fetch('/search/result/stream');
                if (res.ok && res.body) {
                    const reader = res.body.getReader();
                    const decoder = new TextDecoder();
                    let text = '';
                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        text += decoder.decode(value, { stream: true });
                        out.textContent = text;
                    }
                    const finalRes = await fetch('/search/result');
                    const finalData = await finalRes.json();
                    if (finalData && finalData.html) {
                        out.innerHTML = finalData.html;
                    }
                } else {
                    const data = await res.json().catch(() => ({}));
                    out.textContent = JSON.stringify(data, null, 2);
                }
            }
        } catch (e) {
            // swallow errors during polling to avoid UI flicker
        }
    }

    async function beginPolling() {
        if (pollTimer) return;
        await pollStatus();
        pollTimer = setInterval(pollStatus, 1500);
    }

    document.getElementById('submit').onclick = async () => {
        const q = document.getElementById('query').value;
        document.getElementById('result').textContent = '';
        const res = await fetch('/search/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query: q })
        });
        if (res.status === 409) {
            setInProgress(true);
            await beginPolling();
            return;
        }
        if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            document.getElementById('result').textContent = JSON.stringify(err, null, 2);
            return;
        }
        setInProgress(true);
        await beginPolling();
    };

    document.getElementById('cancel').onclick = async () => {
        await fetch('/search/cancel', { method: 'POST' });
        // Give server a moment to settle, then poll status
        setTimeout(pollStatus, 300);
    };

    // On load, check if a query is already running and reflect that
    (async () => {
        const r = await fetch('/search/status');
        const s = await r.json();
        if (s.in_progress) {
            setInProgress(true, s.elapsed_ms || 0);
            await beginPolling();
        }
    })();
    </script>
</body>
</html>
